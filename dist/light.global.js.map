{"version":3,"sources":["../src/light.ts"],"sourcesContent":["interface StorageLike {\n  setItem(id: string, val: string): string;\n  getItem(id: string): string | undefined | null;\n  removeItem(id: string): void;\n  key(index: number): string | null;\n  clear(): void;\n  length: number;\n}\n\ninterface MemoryStorage extends StorageLike {\n  _data: Record<string, string>;\n}\n\ninterface KeyConfig {\n  t?: string;\n  ttl?: number;\n}\n\ninterface Config {\n  [key: string]: KeyConfig | undefined;\n}\n\ninterface SetOptions {\n  ttl?: number | string;\n}\n\ninterface TypeResult {\n  value: string | number;\n  type: string;\n}\n\nlet ls: StorageLike | null =\n  typeof window !== 'undefined' ? (window as unknown as { localStorage: StorageLike }).localStorage : null;\n\n// Provide an in-memory fallback for older browsers.\nif (!ls) {\n  const memoryStorage: MemoryStorage = {\n    _data: {},\n    setItem: function (id: string, val: string) {\n      return (this._data[id] = String(val));\n    },\n    getItem: function (id: string) {\n      return this._data.hasOwnProperty(id) ? this._data[id] : undefined;\n    },\n    removeItem: function (id: string) {\n      return delete this._data[id];\n    },\n    key: function (index: number) {\n      for (const key in this._data) {\n        if (!(index--)) {\n          return key;\n        }\n      }\n      return null;\n    },\n    clear: function () {\n      return (this._data = {});\n    },\n    get length() {\n      return Object.keys(this._data).length;\n    }\n  };\n  ls = memoryStorage;\n}\n\nconst utils = {\n  each: function <T>(arr: T[], iteratee: (item: T, index: number) => void) {\n    let l = arr.length;\n    while (l--) iteratee(arr[l], l);\n  },\n  map: function <T, U>(arr: T[], iteratee: (item: T, index: number) => U): U[] {\n    const newArr = new Array(arr.length) as U[];\n    let l = arr.length;\n    while (l--) newArr[l] = iteratee(arr[l], l);\n    return newArr;\n  },\n  filter: function <T>(arr: T[], iteratee: (item: T, index: number) => boolean): T[] {\n    const newArr: T[] = [];\n    let l = arr.length;\n    while (l--) {\n      if (iteratee(arr[l], l)) newArr.push(arr[l]);\n    }\n    return newArr;\n  }\n};\n\nlet _keys: string[] = [];\nlet _config: Config = {};\nconst _timeouts: Record<string, ReturnType<typeof setTimeout>> = {};\n\nfunction Locally(this: void, options?: object) {\n  options = options || {};\n\n  const configStr = ls!.getItem('locally-config');\n\n  if (!configStr) {\n    _config = {};\n    _rebuildConfig();\n  } else {\n    try {\n      _config = JSON.parse(configStr);\n    } catch (e) {\n      if (!!configStr) {\n        try {\n          _config = JSON.parse(configStr);\n        } catch (e2) {\n          throw new Error('Locally: config is corrupted');\n        }\n      } else throw new Error('Locally: config is corrupted');\n    }\n\n    _rebuildConfig();\n  }\n\n  _saveConfig();\n\n  Object.defineProperty(this, 'length', {\n    get: function () {\n      return _keys.length;\n    }\n  });\n}\n\nLocally.prototype.set = function (\n  key: string,\n  value: unknown,\n  options?: SetOptions | number | string\n) {\n  if (arguments.length < 2) throw new Error('Locally: no key or value given');\n\n  let opts: SetOptions = (options as SetOptions) || {};\n\n  if (typeof options !== 'object') {\n    opts = { ttl: options as number | string };\n  }\n\n  if (typeof opts.ttl === 'string') {\n    opts.ttl = parseInt(opts.ttl, 10);\n\n    if (isNaN(opts.ttl)) {\n      throw new Error(\n        \"Locally: ttl should be a number in /light version of Locally.\"\n      );\n    }\n  }\n\n  _config[key] = _config[key] || {};\n\n  if (_keys.indexOf(key) === -1) {\n    _keys.push(key);\n  }\n\n  if (opts.ttl && !isNaN(opts.ttl as number)) {\n    _clearTimeout(key);\n    _setTimeout(key, opts.ttl as number);\n  } else if (_config[key]!.ttl) {\n    _clearTimeout(key);\n  }\n\n  const res = _getType(value);\n\n  value = res.value;\n  _config[key]!.t = res.type;\n\n  const keyStr = String(key);\n  const valueStr = String(value);\n\n  ls!.setItem(keyStr, valueStr);\n  _saveConfig();\n};\n\nLocally.prototype.get = function (key: string | string[]) {\n  return Array.isArray(key)\n    ? utils.map(key, (item) => _get(item as string))\n    : _get(key);\n};\n\nLocally.prototype.keys = function (pattern?: string | RegExp) {\n  if (!pattern || pattern === '*') return _keys.slice(0);\n\n  const regex = !(pattern instanceof RegExp)\n    ? new RegExp('.*' + pattern + '.*')\n    : pattern;\n\n  return utils.filter(_keys, (key) => regex.test(key));\n};\n\nLocally.prototype.remove = function (key: string | string[]) {\n  if (typeof key === 'undefined')\n    throw new Error(\"Locally: 'remove' requires a key\");\n\n  if (Array.isArray(key)) {\n    utils.each(key, _remove);\n  } else {\n    _remove(key);\n  }\n};\n\nLocally.prototype.scan = function (key: string | RegExp, fn: (value: unknown, key: string) => void) {\n  return utils.each(this.keys(key), (keyName: string) => {\n    fn(_get(keyName), keyName);\n  });\n};\n\nLocally.prototype.ttl = function (key: string) {\n  const cfg = _config[key];\n  if (!cfg) return -2;\n  if (!cfg.ttl) return -1;\n  return cfg.ttl - Date.now();\n};\n\nLocally.prototype.persist = function (key: string) {\n  return _config[key]\n    ? !!(delete _config[key]!.ttl && _saveConfig() && _clearTimeout(key))\n    : false;\n};\n\nLocally.prototype.expire = function (key: string, ttl: number) {\n  return _config[key]\n    ? !!((_config[key]!.ttl = Date.now() + ttl) && _saveConfig())\n    : false;\n};\n\nLocally.prototype.clear = function () {\n  ls!.clear();\n  _config = {};\n  _keys = [];\n  return _saveConfig();\n};\n\nLocally.prototype.key = function (index: number) {\n  return _keys[index];\n};\n\nfunction _remove(key: string) {\n  const i = _keys.indexOf(key);\n  if (i > -1) {\n    ls!.removeItem(key);\n    _keys.splice(_keys.indexOf(key), 1);\n    delete _config[key];\n  }\n}\n\nfunction _saveConfig() {\n  ls!.setItem('locally-config', JSON.stringify(_config));\n  return true;\n}\n\nfunction _get(key: string): unknown {\n  if (typeof key === 'undefined' || !_config[key]) return null;\n\n  if (_config[key]!.ttl && _config[key]!.ttl! < Date.now()) {\n    delete _config[key];\n    _saveConfig();\n    _remove(key);\n    return null;\n  }\n\n  let temp: unknown;\n  const value = ls!.getItem(key);\n\n  switch (_config[key]!.t) {\n    case 'o':\n      try {\n        return JSON.parse(value as string);\n      } catch (e) {}\n      return null;\n\n    case 'd':\n      return new Date(parseInt(value as string, 10));\n\n    case 'r':\n      return new RegExp((value as string).substring(1, (value as string).length - 1));\n\n    case 'f':\n      eval('temp = ' + value);\n      return temp;\n\n    case 'n':\n      return Number(value);\n\n    case 'b':\n      return value === '1';\n\n    case 's':\n    default:\n      if (value === 'null') return null;\n      else if (value === 'undefined') return undefined;\n      else return String(value);\n  }\n}\n\nfunction _getType(value: unknown): TypeResult {\n  let type: string;\n\n  switch (typeof value) {\n    case 'object':\n      if (value instanceof Date) {\n        value = (value as Date).getTime();\n        type = 'd';\n      } else if (value instanceof RegExp) {\n        value = (value as RegExp).toString();\n        type = 'r';\n      } else {\n        value = JSON.stringify(value);\n        type = 'o';\n      }\n      break;\n\n    case 'function':\n      type = 'f';\n      break;\n\n    case 'number':\n      type = 'n';\n      break;\n\n    case 'boolean':\n      value = value ? 1 : 0;\n      type = 'b';\n      break;\n\n    case 'string':\n    default:\n      type = 's';\n  }\n\n  return {\n    value: value as string | number,\n    type\n  };\n}\n\nfunction _rebuildConfig() {\n  const len = ls!.length;\n  _keys = new Array(len);\n\n  let l = len;\n  while (l--) {\n    _keys[l] = ls!.key(l) || '';\n    _config[_keys[l]] = _config[_keys[l]] || {};\n    ls!.setItem(_keys[l], ls!.getItem(_keys[l]) || '');\n\n    if (_config[_keys[l]]!.ttl) {\n      _setTimeout(_keys[l], _config[_keys[l]]!.ttl! - Date.now());\n    }\n  }\n\n  const configIndex = _keys.indexOf('locally-config');\n  if (configIndex > -1) {\n    _keys.splice(configIndex, 1);\n  }\n}\n\nfunction _setTimeout(key: string, ttl: number) {\n  _config[key] = _config[key] || {};\n  _config[key]!.ttl = Date.now() + ttl;\n  _timeouts[key] = setTimeout(() => {\n    _remove(key);\n  }, ttl);\n}\n\nfunction _clearTimeout(key: string) {\n  if (_keys.indexOf(key) > -1) {\n    clearTimeout(_timeouts[key]);\n    delete _timeouts[key];\n    delete _config[key]!.ttl;\n    return true;\n  }\n  return false;\n}\n\nexport { Locally as Store };\n"],"mappings":"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","names":["key","value"]}