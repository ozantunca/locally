{"version":3,"sources":["../src/light.ts"],"sourcesContent":["interface StorageLike {\n  setItem(id: string, val: string): string;\n  getItem(id: string): string | undefined | null;\n  removeItem(id: string): void;\n  key(index: number): string | null;\n  clear(): void;\n  length: number;\n}\n\ninterface MemoryStorage extends StorageLike {\n  _data: Record<string, string>;\n}\n\ninterface KeyConfig {\n  t?: string;\n  ttl?: number;\n}\n\ninterface Config {\n  [key: string]: KeyConfig | undefined;\n}\n\ninterface SetOptions {\n  ttl?: number | string;\n}\n\ninterface TypeResult {\n  value: string | number;\n  type: string;\n}\n\nlet ls: StorageLike | null =\n  typeof window !== 'undefined' ? (window as unknown as { localStorage: StorageLike }).localStorage : null;\n\n// Provide an in-memory fallback for older browsers.\nif (!ls) {\n  const memoryStorage: MemoryStorage = {\n    _data: {},\n    setItem: function (id: string, val: string) {\n      return (this._data[id] = String(val));\n    },\n    getItem: function (id: string) {\n      return this._data.hasOwnProperty(id) ? this._data[id] : undefined;\n    },\n    removeItem: function (id: string) {\n      return delete this._data[id];\n    },\n    key: function (index: number) {\n      for (const key in this._data) {\n        if (!(index--)) {\n          return key;\n        }\n      }\n      return null;\n    },\n    clear: function () {\n      return (this._data = {});\n    },\n    get length() {\n      return Object.keys(this._data).length;\n    }\n  };\n  ls = memoryStorage;\n}\n\nconst utils = {\n  each: function <T>(arr: T[], iteratee: (item: T, index: number) => void) {\n    let l = arr.length;\n    while (l--) iteratee(arr[l], l);\n  },\n  map: function <T, U>(arr: T[], iteratee: (item: T, index: number) => U): U[] {\n    const newArr = new Array(arr.length) as U[];\n    let l = arr.length;\n    while (l--) newArr[l] = iteratee(arr[l], l);\n    return newArr;\n  },\n  filter: function <T>(arr: T[], iteratee: (item: T, index: number) => boolean): T[] {\n    const newArr: T[] = [];\n    let l = arr.length;\n    while (l--) {\n      if (iteratee(arr[l], l)) newArr.push(arr[l]);\n    }\n    return newArr;\n  }\n};\n\nlet _keys: string[] = [];\nlet _config: Config = {};\nconst _timeouts: Record<string, ReturnType<typeof setTimeout>> = {};\n\nfunction Locally(this: void, options?: object) {\n  options = options || {};\n\n  const configStr = ls!.getItem('locally-config');\n\n  if (!configStr) {\n    _config = {};\n    _rebuildConfig();\n  } else {\n    try {\n      _config = JSON.parse(configStr);\n    } catch (e) {\n      if (!!configStr) {\n        try {\n          _config = JSON.parse(configStr);\n        } catch (e2) {\n          throw new Error('Locally: config is corrupted');\n        }\n      } else throw new Error('Locally: config is corrupted');\n    }\n\n    _rebuildConfig();\n  }\n\n  _saveConfig();\n\n  Object.defineProperty(this, 'length', {\n    get: function () {\n      return _keys.length;\n    }\n  });\n}\n\nLocally.prototype.set = function (\n  key: string,\n  value: unknown,\n  options?: SetOptions | number | string\n) {\n  if (arguments.length < 2) throw new Error('Locally: no key or value given');\n\n  let opts: SetOptions = (options as SetOptions) || {};\n\n  if (typeof options !== 'object') {\n    opts = { ttl: options as number | string };\n  }\n\n  if (typeof opts.ttl === 'string') {\n    opts.ttl = parseInt(opts.ttl, 10);\n\n    if (isNaN(opts.ttl)) {\n      throw new Error(\n        \"Locally: ttl should be a number in /light version of Locally.\"\n      );\n    }\n  }\n\n  _config[key] = _config[key] || {};\n\n  if (_keys.indexOf(key) === -1) {\n    _keys.push(key);\n  }\n\n  if (opts.ttl && !isNaN(opts.ttl as number)) {\n    _clearTimeout(key);\n    _setTimeout(key, opts.ttl as number);\n  } else if (_config[key]!.ttl) {\n    _clearTimeout(key);\n  }\n\n  const res = _getType(value);\n\n  value = res.value;\n  _config[key]!.t = res.type;\n\n  const keyStr = String(key);\n  const valueStr = String(value);\n\n  ls!.setItem(keyStr, valueStr);\n  _saveConfig();\n};\n\nLocally.prototype.get = function (key: string | string[]) {\n  return Array.isArray(key)\n    ? utils.map(key, (item) => _get(item as string))\n    : _get(key);\n};\n\nLocally.prototype.keys = function (pattern?: string | RegExp) {\n  if (!pattern || pattern === '*') return _keys.slice(0);\n\n  const regex = !(pattern instanceof RegExp)\n    ? new RegExp('.*' + pattern + '.*')\n    : pattern;\n\n  return utils.filter(_keys, (key) => regex.test(key));\n};\n\nLocally.prototype.remove = function (key: string | string[]) {\n  if (typeof key === 'undefined')\n    throw new Error(\"Locally: 'remove' requires a key\");\n\n  if (Array.isArray(key)) {\n    utils.each(key, _remove);\n  } else {\n    _remove(key);\n  }\n};\n\nLocally.prototype.scan = function (key: string | RegExp, fn: (value: unknown, key: string) => void) {\n  return utils.each(this.keys(key), (keyName: string) => {\n    fn(_get(keyName), keyName);\n  });\n};\n\nLocally.prototype.ttl = function (key: string) {\n  const cfg = _config[key];\n  if (!cfg) return -2;\n  if (!cfg.ttl) return -1;\n  return cfg.ttl - Date.now();\n};\n\nLocally.prototype.persist = function (key: string) {\n  return _config[key]\n    ? !!(delete _config[key]!.ttl && _saveConfig() && _clearTimeout(key))\n    : false;\n};\n\nLocally.prototype.expire = function (key: string, ttl: number) {\n  return _config[key]\n    ? !!((_config[key]!.ttl = Date.now() + ttl) && _saveConfig())\n    : false;\n};\n\nLocally.prototype.clear = function () {\n  ls!.clear();\n  _config = {};\n  _keys = [];\n  return _saveConfig();\n};\n\nLocally.prototype.key = function (index: number) {\n  return _keys[index];\n};\n\nfunction _remove(key: string) {\n  const i = _keys.indexOf(key);\n  if (i > -1) {\n    ls!.removeItem(key);\n    _keys.splice(_keys.indexOf(key), 1);\n    delete _config[key];\n  }\n}\n\nfunction _saveConfig() {\n  ls!.setItem('locally-config', JSON.stringify(_config));\n  return true;\n}\n\nfunction _get(key: string): unknown {\n  if (typeof key === 'undefined' || !_config[key]) return null;\n\n  if (_config[key]!.ttl && _config[key]!.ttl! < Date.now()) {\n    delete _config[key];\n    _saveConfig();\n    _remove(key);\n    return null;\n  }\n\n  let temp: unknown;\n  const value = ls!.getItem(key);\n\n  switch (_config[key]!.t) {\n    case 'o':\n      try {\n        return JSON.parse(value as string);\n      } catch (e) {}\n      return null;\n\n    case 'd':\n      return new Date(parseInt(value as string, 10));\n\n    case 'r':\n      return new RegExp((value as string).substring(1, (value as string).length - 1));\n\n    case 'f':\n      eval('temp = ' + value);\n      return temp;\n\n    case 'n':\n      return Number(value);\n\n    case 'b':\n      return value === '1';\n\n    case 's':\n    default:\n      if (value === 'null') return null;\n      else if (value === 'undefined') return undefined;\n      else return String(value);\n  }\n}\n\nfunction _getType(value: unknown): TypeResult {\n  let type: string;\n\n  switch (typeof value) {\n    case 'object':\n      if (value instanceof Date) {\n        value = (value as Date).getTime();\n        type = 'd';\n      } else if (value instanceof RegExp) {\n        value = (value as RegExp).toString();\n        type = 'r';\n      } else {\n        value = JSON.stringify(value);\n        type = 'o';\n      }\n      break;\n\n    case 'function':\n      type = 'f';\n      break;\n\n    case 'number':\n      type = 'n';\n      break;\n\n    case 'boolean':\n      value = value ? 1 : 0;\n      type = 'b';\n      break;\n\n    case 'string':\n    default:\n      type = 's';\n  }\n\n  return {\n    value: value as string | number,\n    type\n  };\n}\n\nfunction _rebuildConfig() {\n  const len = ls!.length;\n  _keys = new Array(len);\n\n  let l = len;\n  while (l--) {\n    _keys[l] = ls!.key(l) || '';\n    _config[_keys[l]] = _config[_keys[l]] || {};\n    ls!.setItem(_keys[l], ls!.getItem(_keys[l]) || '');\n\n    if (_config[_keys[l]]!.ttl) {\n      const remaining = _config[_keys[l]]!.ttl! - Date.now();\n      if (remaining <= 0) {\n        _remove(_keys[l]);\n      } else {\n        _setTimeout(_keys[l], remaining);\n      }\n    }\n  }\n\n  const configIndex = _keys.indexOf('locally-config');\n  if (configIndex > -1) {\n    _keys.splice(configIndex, 1);\n  }\n}\n\nfunction _setTimeout(key: string, ttl: number) {\n  _config[key] = _config[key] || {};\n  _config[key]!.ttl = Date.now() + ttl;\n  _timeouts[key] = setTimeout(() => {\n    _remove(key);\n  }, ttl);\n}\n\nfunction _clearTimeout(key: string) {\n  if (_keys.indexOf(key) > -1) {\n    clearTimeout(_timeouts[key]);\n    delete _timeouts[key];\n    delete _config[key]!.ttl;\n    return true;\n  }\n  return false;\n}\n\nexport { Locally as Store };\n"],"mappings":";AA+BA,IAAI,KACF,OAAO,WAAW,cAAe,OAAoD,eAAe;AAGtG,IAAI,CAAC,IAAI;AACP,QAAM,gBAA+B;AAAA,IACnC,OAAO,CAAC;AAAA,IACR,SAAS,SAAU,IAAY,KAAa;AAC1C,aAAQ,KAAK,MAAM,EAAE,IAAI,OAAO,GAAG;AAAA,IACrC;AAAA,IACA,SAAS,SAAU,IAAY;AAC7B,aAAO,KAAK,MAAM,eAAe,EAAE,IAAI,KAAK,MAAM,EAAE,IAAI;AAAA,IAC1D;AAAA,IACA,YAAY,SAAU,IAAY;AAChC,aAAO,OAAO,KAAK,MAAM,EAAE;AAAA,IAC7B;AAAA,IACA,KAAK,SAAU,OAAe;AAC5B,iBAAWA,QAAO,KAAK,OAAO;AAC5B,YAAI,CAAE,SAAU;AACd,iBAAOA;AAAA,QACT;AAAA,MACF;AACA,aAAO;AAAA,IACT;AAAA,IACA,OAAO,WAAY;AACjB,aAAQ,KAAK,QAAQ,CAAC;AAAA,IACxB;AAAA,IACA,IAAI,SAAS;AACX,aAAO,OAAO,KAAK,KAAK,KAAK,EAAE;AAAA,IACjC;AAAA,EACF;AACA,OAAK;AACP;AAEA,IAAM,QAAQ;AAAA,EACZ,MAAM,SAAa,KAAU,UAA4C;AACvE,QAAI,IAAI,IAAI;AACZ,WAAO,IAAK,UAAS,IAAI,CAAC,GAAG,CAAC;AAAA,EAChC;AAAA,EACA,KAAK,SAAgB,KAAU,UAA8C;AAC3E,UAAM,SAAS,IAAI,MAAM,IAAI,MAAM;AACnC,QAAI,IAAI,IAAI;AACZ,WAAO,IAAK,QAAO,CAAC,IAAI,SAAS,IAAI,CAAC,GAAG,CAAC;AAC1C,WAAO;AAAA,EACT;AAAA,EACA,QAAQ,SAAa,KAAU,UAAoD;AACjF,UAAM,SAAc,CAAC;AACrB,QAAI,IAAI,IAAI;AACZ,WAAO,KAAK;AACV,UAAI,SAAS,IAAI,CAAC,GAAG,CAAC,EAAG,QAAO,KAAK,IAAI,CAAC,CAAC;AAAA,IAC7C;AACA,WAAO;AAAA,EACT;AACF;AAEA,IAAI,QAAkB,CAAC;AACvB,IAAI,UAAkB,CAAC;AACvB,IAAM,YAA2D,CAAC;AAElE,SAAS,QAAoB,SAAkB;AAC7C,YAAU,WAAW,CAAC;AAEtB,QAAM,YAAY,GAAI,QAAQ,gBAAgB;AAE9C,MAAI,CAAC,WAAW;AACd,cAAU,CAAC;AACX,mBAAe;AAAA,EACjB,OAAO;AACL,QAAI;AACF,gBAAU,KAAK,MAAM,SAAS;AAAA,IAChC,SAAS,GAAG;AACV,UAAI,CAAC,CAAC,WAAW;AACf,YAAI;AACF,oBAAU,KAAK,MAAM,SAAS;AAAA,QAChC,SAAS,IAAI;AACX,gBAAM,IAAI,MAAM,8BAA8B;AAAA,QAChD;AAAA,MACF,MAAO,OAAM,IAAI,MAAM,8BAA8B;AAAA,IACvD;AAEA,mBAAe;AAAA,EACjB;AAEA,cAAY;AAEZ,SAAO,eAAe,MAAM,UAAU;AAAA,IACpC,KAAK,WAAY;AACf,aAAO,MAAM;AAAA,IACf;AAAA,EACF,CAAC;AACH;AAEA,QAAQ,UAAU,MAAM,SACtBA,MACAC,QACA,SACA;AACA,MAAI,UAAU,SAAS,EAAG,OAAM,IAAI,MAAM,gCAAgC;AAE1E,MAAI,OAAoB,WAA0B,CAAC;AAEnD,MAAI,OAAO,YAAY,UAAU;AAC/B,WAAO,EAAE,KAAK,QAA2B;AAAA,EAC3C;AAEA,MAAI,OAAO,KAAK,QAAQ,UAAU;AAChC,SAAK,MAAM,SAAS,KAAK,KAAK,EAAE;AAEhC,QAAI,MAAM,KAAK,GAAG,GAAG;AACnB,YAAM,IAAI;AAAA,QACR;AAAA,MACF;AAAA,IACF;AAAA,EACF;AAEA,UAAQD,IAAG,IAAI,QAAQA,IAAG,KAAK,CAAC;AAEhC,MAAI,MAAM,QAAQA,IAAG,MAAM,IAAI;AAC7B,UAAM,KAAKA,IAAG;AAAA,EAChB;AAEA,MAAI,KAAK,OAAO,CAAC,MAAM,KAAK,GAAa,GAAG;AAC1C,kBAAcA,IAAG;AACjB,gBAAYA,MAAK,KAAK,GAAa;AAAA,EACrC,WAAW,QAAQA,IAAG,EAAG,KAAK;AAC5B,kBAAcA,IAAG;AAAA,EACnB;AAEA,QAAM,MAAM,SAASC,MAAK;AAE1B,EAAAA,SAAQ,IAAI;AACZ,UAAQD,IAAG,EAAG,IAAI,IAAI;AAEtB,QAAM,SAAS,OAAOA,IAAG;AACzB,QAAM,WAAW,OAAOC,MAAK;AAE7B,KAAI,QAAQ,QAAQ,QAAQ;AAC5B,cAAY;AACd;AAEA,QAAQ,UAAU,MAAM,SAAUD,MAAwB;AACxD,SAAO,MAAM,QAAQA,IAAG,IACpB,MAAM,IAAIA,MAAK,CAAC,SAAS,KAAK,IAAc,CAAC,IAC7C,KAAKA,IAAG;AACd;AAEA,QAAQ,UAAU,OAAO,SAAU,SAA2B;AAC5D,MAAI,CAAC,WAAW,YAAY,IAAK,QAAO,MAAM,MAAM,CAAC;AAErD,QAAM,QAAQ,EAAE,mBAAmB,UAC/B,IAAI,OAAO,OAAO,UAAU,IAAI,IAChC;AAEJ,SAAO,MAAM,OAAO,OAAO,CAACA,SAAQ,MAAM,KAAKA,IAAG,CAAC;AACrD;AAEA,QAAQ,UAAU,SAAS,SAAUA,MAAwB;AAC3D,MAAI,OAAOA,SAAQ;AACjB,UAAM,IAAI,MAAM,kCAAkC;AAEpD,MAAI,MAAM,QAAQA,IAAG,GAAG;AACtB,UAAM,KAAKA,MAAK,OAAO;AAAA,EACzB,OAAO;AACL,YAAQA,IAAG;AAAA,EACb;AACF;AAEA,QAAQ,UAAU,OAAO,SAAUA,MAAsB,IAA2C;AAClG,SAAO,MAAM,KAAK,KAAK,KAAKA,IAAG,GAAG,CAAC,YAAoB;AACrD,OAAG,KAAK,OAAO,GAAG,OAAO;AAAA,EAC3B,CAAC;AACH;AAEA,QAAQ,UAAU,MAAM,SAAUA,MAAa;AAC7C,QAAM,MAAM,QAAQA,IAAG;AACvB,MAAI,CAAC,IAAK,QAAO;AACjB,MAAI,CAAC,IAAI,IAAK,QAAO;AACrB,SAAO,IAAI,MAAM,KAAK,IAAI;AAC5B;AAEA,QAAQ,UAAU,UAAU,SAAUA,MAAa;AACjD,SAAO,QAAQA,IAAG,IACd,CAAC,EAAE,OAAO,QAAQA,IAAG,EAAG,OAAO,YAAY,KAAK,cAAcA,IAAG,KACjE;AACN;AAEA,QAAQ,UAAU,SAAS,SAAUA,MAAa,KAAa;AAC7D,SAAO,QAAQA,IAAG,IACd,CAAC,GAAG,QAAQA,IAAG,EAAG,MAAM,KAAK,IAAI,IAAI,QAAQ,YAAY,KACzD;AACN;AAEA,QAAQ,UAAU,QAAQ,WAAY;AACpC,KAAI,MAAM;AACV,YAAU,CAAC;AACX,UAAQ,CAAC;AACT,SAAO,YAAY;AACrB;AAEA,QAAQ,UAAU,MAAM,SAAU,OAAe;AAC/C,SAAO,MAAM,KAAK;AACpB;AAEA,SAAS,QAAQA,MAAa;AAC5B,QAAM,IAAI,MAAM,QAAQA,IAAG;AAC3B,MAAI,IAAI,IAAI;AACV,OAAI,WAAWA,IAAG;AAClB,UAAM,OAAO,MAAM,QAAQA,IAAG,GAAG,CAAC;AAClC,WAAO,QAAQA,IAAG;AAAA,EACpB;AACF;AAEA,SAAS,cAAc;AACrB,KAAI,QAAQ,kBAAkB,KAAK,UAAU,OAAO,CAAC;AACrD,SAAO;AACT;AAEA,SAAS,KAAK,KAAsB;AAClC,MAAI,OAAO,QAAQ,eAAe,CAAC,QAAQ,GAAG,EAAG,QAAO;AAExD,MAAI,QAAQ,GAAG,EAAG,OAAO,QAAQ,GAAG,EAAG,MAAO,KAAK,IAAI,GAAG;AACxD,WAAO,QAAQ,GAAG;AAClB,gBAAY;AACZ,YAAQ,GAAG;AACX,WAAO;AAAA,EACT;AAEA,MAAI;AACJ,QAAM,QAAQ,GAAI,QAAQ,GAAG;AAE7B,UAAQ,QAAQ,GAAG,EAAG,GAAG;AAAA,IACvB,KAAK;AACH,UAAI;AACF,eAAO,KAAK,MAAM,KAAe;AAAA,MACnC,SAAS,GAAG;AAAA,MAAC;AACb,aAAO;AAAA,IAET,KAAK;AACH,aAAO,IAAI,KAAK,SAAS,OAAiB,EAAE,CAAC;AAAA,IAE/C,KAAK;AACH,aAAO,IAAI,OAAQ,MAAiB,UAAU,GAAI,MAAiB,SAAS,CAAC,CAAC;AAAA,IAEhF,KAAK;AACH,WAAK,YAAY,KAAK;AACtB,aAAO;AAAA,IAET,KAAK;AACH,aAAO,OAAO,KAAK;AAAA,IAErB,KAAK;AACH,aAAO,UAAU;AAAA,IAEnB,KAAK;AAAA,IACL;AACE,UAAI,UAAU,OAAQ,QAAO;AAAA,eACpB,UAAU,YAAa,QAAO;AAAA,UAClC,QAAO,OAAO,KAAK;AAAA,EAC5B;AACF;AAEA,SAAS,SAASC,QAA4B;AAC5C,MAAI;AAEJ,UAAQ,OAAOA,QAAO;AAAA,IACpB,KAAK;AACH,UAAIA,kBAAiB,MAAM;AACzB,QAAAA,SAASA,OAAe,QAAQ;AAChC,eAAO;AAAA,MACT,WAAWA,kBAAiB,QAAQ;AAClC,QAAAA,SAASA,OAAiB,SAAS;AACnC,eAAO;AAAA,MACT,OAAO;AACL,QAAAA,SAAQ,KAAK,UAAUA,MAAK;AAC5B,eAAO;AAAA,MACT;AACA;AAAA,IAEF,KAAK;AACH,aAAO;AACP;AAAA,IAEF,KAAK;AACH,aAAO;AACP;AAAA,IAEF,KAAK;AACH,MAAAA,SAAQA,SAAQ,IAAI;AACpB,aAAO;AACP;AAAA,IAEF,KAAK;AAAA,IACL;AACE,aAAO;AAAA,EACX;AAEA,SAAO;AAAA,IACL,OAAOA;AAAA,IACP;AAAA,EACF;AACF;AAEA,SAAS,iBAAiB;AACxB,QAAM,MAAM,GAAI;AAChB,UAAQ,IAAI,MAAM,GAAG;AAErB,MAAI,IAAI;AACR,SAAO,KAAK;AACV,UAAM,CAAC,IAAI,GAAI,IAAI,CAAC,KAAK;AACzB,YAAQ,MAAM,CAAC,CAAC,IAAI,QAAQ,MAAM,CAAC,CAAC,KAAK,CAAC;AAC1C,OAAI,QAAQ,MAAM,CAAC,GAAG,GAAI,QAAQ,MAAM,CAAC,CAAC,KAAK,EAAE;AAEjD,QAAI,QAAQ,MAAM,CAAC,CAAC,EAAG,KAAK;AAC1B,YAAM,YAAY,QAAQ,MAAM,CAAC,CAAC,EAAG,MAAO,KAAK,IAAI;AACrD,UAAI,aAAa,GAAG;AAClB,gBAAQ,MAAM,CAAC,CAAC;AAAA,MAClB,OAAO;AACL,oBAAY,MAAM,CAAC,GAAG,SAAS;AAAA,MACjC;AAAA,IACF;AAAA,EACF;AAEA,QAAM,cAAc,MAAM,QAAQ,gBAAgB;AAClD,MAAI,cAAc,IAAI;AACpB,UAAM,OAAO,aAAa,CAAC;AAAA,EAC7B;AACF;AAEA,SAAS,YAAYD,MAAa,KAAa;AAC7C,UAAQA,IAAG,IAAI,QAAQA,IAAG,KAAK,CAAC;AAChC,UAAQA,IAAG,EAAG,MAAM,KAAK,IAAI,IAAI;AACjC,YAAUA,IAAG,IAAI,WAAW,MAAM;AAChC,YAAQA,IAAG;AAAA,EACb,GAAG,GAAG;AACR;AAEA,SAAS,cAAcA,MAAa;AAClC,MAAI,MAAM,QAAQA,IAAG,IAAI,IAAI;AAC3B,iBAAa,UAAUA,IAAG,CAAC;AAC3B,WAAO,UAAUA,IAAG;AACpB,WAAO,QAAQA,IAAG,EAAG;AACrB,WAAO;AAAA,EACT;AACA,SAAO;AACT;","names":["key","value"]}